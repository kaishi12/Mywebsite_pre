@model MyWebsite.Models.Chapter

@{
    Layout = "~/Views/Shared/_LayoutUser.cshtml";
}
<style>
</style>
<div class="padding">
    <div class="m-b black rounded">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/Account/UserManagment">Home</a></li>
            <li class="breadcrumb-item"><a href="/Contribute/EditorList">Upload Clear-text</a></li>
        </ol>
    </div>
    <div class="box-header blue" style="margin-bottom:5px">
        <h2>Upload Clear-text: @ViewBag.MangaFullName</h2>
    </div>
    <div>
       
        <div class="row" style="padding-bottom:10px;padding-left:0px">
            <div class="col-sm-4">
                <select class="form-control c-select" id="ChapterList" name="ChapterList">
                    @foreach (var item in ViewBag.chapterlist)
                    {
                        if (item.ChapterId == Model.ChapterId)
                        {
                            <option value="@item.ChapterId" selected>@item.FullName</option>
                        }
                        else
                        { 
                        <option value="@item.ChapterId">@item.FullName</option>
                        }
                    }
                </select>
            </div>
            <div class="col-sm-4">
                <select class="form-control c-select" id="CategoryId" name="CategoryId">
                    @if (ViewBag.CategoryId == 1)
                    {
                        <option value="1" selected>Trang Raw</option>
                        <option value="2">Trang Clear-text</option>
                    }
                    else
                    {
                        <option value="1">Trang Raw</option>
                        <option value="2" selected>Trang Clear-text</option>
                    }

                </select>
            </div>
        </div>


        <div class="tab-content pos-rlt">





            <div class="row">
                @foreach (var item in Model.Pages.Where(m=>m.CategoryId == ViewBag.CategoryId))
                {
                    if (item.StatusActive == 0 && ViewBag.CategoryId == 1)
                    {
                        <div id=@("Raw" + item.PageId) class="raw col-xs-6 col-sm-4 col-md-3" style="padding-left:12px;padding-right:12px">
                            <div class="box p-a-xs">

                                <form id=@("AddNewPage" + item.PageId) enctype="multipart/form-data">

                                    <input type="hidden" name="PageId" id="PageId" value="@item.PageId" />

                                    <a href="~/PageLink/@item.PageLink"><img style="max-height:300px" data-target="#myModal" id=@item.PageId src="~/PageLink/@item.PageLink" alt="" class="img-responsive"></a>
                                    <div class="p-a-sm">
                                        <div class=" text-ellipsis">
                                            <span>trang @item.OrderNumber</span>

                                            <input hidden type="file" id="@("file"+item.PageId)" name="fileupload" onchange="Upload(this)" />

                                        </div>


                                        <div style="padding-bottom:0px" class="box-footer row">
                                            <button id="@item.PageId" type="button" class="UploadButton md-btn md-raised m-b-sm w-xs accent" style="display: block;margin-left: auto;margin-right: auto;">Upload</button>
                                            <button type="button" class="md-btn md-raised m-b-sm w-xs primary" style="display: block;margin-left: auto;margin-right: auto;"><a download href="~/PageLink/@item.PageLink">Tải xuống</a></button>
                                            <button onclick="SavePage(this)" type="button" disabled id=@("Save" + @item.PageId) class="md-btn md-raised m-b-sm w-xs info" style="display: block;margin-left: auto;margin-right: auto;">Lưu</button>
                                        </div>

                                    </div>

                                </form>
                            </div>
                        </div>

                    }
                    else
                    
                    {

                        <div id=@("Clear-text" + item.PageId) class="clear-text col-xs-6 col-sm-4 col-md-3" style="padding-left:12px;padding-right:12px">
                            <div class="box p-a-xs">
                                <form id=@("UpdatePage" + item.PageId) enctype="multipart/form-data">

                                    <input type="hidden" name="PageId" id="PageId" value="@item.PageId" />

                                    <a href="~/PageLink/@item.PageLink"><img style="max-height:300px" id=@item.PageId src="~/PageLink/@item.PageLink" alt="" class="img-responsive"></a>
                                    <div class="p-a-sm">
                                        <div class="text-ellipsis">
                                            trang @item.OrderNumber
                                            <input hidden style="margin-left:10px" type="file" id="@("file"+item.PageId)" name="fileupload" onchange="Upload(this)" />
                                            <br />
                                            @if (item.StatusActive == 1)
                                            {
                                                <span class="text-muted"> Chưa được duyệt</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Đã được duyệt</span>
                                            }
                                        </div>


                                        <div style="padding-bottom:0px" class="box-footer row">
                                            @if (item.StatusActive == 1)
                                            {
                                                <button id="@item.PageId" type="button" class="UploadButton md-btn md-raised m-b-sm w-xs accent" style="display: block;margin-left: auto;margin-right: auto;">Upload</button>
                                            }
                                            else
                                            {
                                                <button disabled type="button" class="md-btn md-raised m-b-sm w-xs accent" style="display: block;margin-left: auto;margin-right: auto;">Upload</button>
                                            }

                                            <button  type="button" class="md-btn md-raised m-b-sm w-xs primary" style="display: block;margin-left: auto;margin-right: auto;"><a download href="~/PageLink/@item.PageLink">Tải xuống</a></button>
                                            <button onclick="UpdatePage(this)" type="button" disabled id=@("Save" + @item.PageId) class="md-btn md-raised m-b-sm w-xs info" style="display: block;margin-left: auto;margin-right: auto;">Lưu</button>
                                        </div>

                                    </div>

                                </form>
                            </div>
                        </div>

                    }
                }


            </div>



        </div>

    </div>
</div>


@section scripts
{
    <script>
        $(".UploadButton").click(function () {
            
            let str = "#file" + this.id;
            $(str).click();
            })
        function Upload(input) {

            let value = "img" + "#" + input.id.replace("file","");
            let valuebuttonSave = "#Save" + input.id.replace("file","");
            console.log(input.id.replace("file",""));
            if (input.files && input.files[0]) {

                var reader = new FileReader();

                reader.onload = function (e) {
                    $(value).prop("src", reader.result);
                };

                reader.readAsDataURL(input.files[0]);
                $(valuebuttonSave).prop("disabled", false);
            }

        }
        function SavePage(input) {

            let PageId = input.id.replace("Save", "");
            let value = "#AddNewPage" + PageId;
            let formdata = new FormData($(value).get(0));
            
            $.ajax({
                url: "/Chapter/AddNewCleartextPage",
                type: "post",

                data: formdata,
                cache: false,
                processData: false,
                contentType: false,
                success: function (result) {
                    if (result == true) {
                        alert("Lưu thành công");
                    }
                }
            });
        }
        function UpdatePage(input) {

            let PageId = input.id.replace("Save", "");
            let value = "#UpdatePage" + PageId;
            let formdata = new FormData($(value).get(0));
            console.log(value);
            alert(formdata);
            $.ajax({
                url: "/Chapter/UpdateLinkPage",
                type: "post",

                data: formdata,
                cache: false,
                processData: false,
                contentType: false,
                success: function (result) {
                    if (result == true) {
                        alert("Lưu thành công");
                    }
                }
            });
        }
        $("#CategoryId").on("change", function () {
            
                window.location.href = "/Contribute/Editor?ChapterId="+$("#ChapterList").val()+"&CategoryId="+$(this).val();
          
        })
        $("#ChapterList").on("change", function () {
            
                window.location.href = "/Contribute/Editor?ChapterId="+$(this).val();
          
        })

    </script>
}


